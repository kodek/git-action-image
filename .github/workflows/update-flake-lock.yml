name: Update flake.lock weekly

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  TARGET: .#docker

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Install Nix with flakes
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: ğŸ“¦ Build current target (baseline)
        run: |
          nix build "$TARGET" -o before || echo "nothing to build"

      - name: ğŸ”„ Update flake.lock
        run: |
          nix flake update
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"
          git add flake.lock
          git commit -m "chore: update flake.lock"

      - name: ğŸ“¦ Build updated target
        run: |
          nix build "$TARGET" -o after || echo "nothing to build"

      - name: ğŸ“ Generate package diff
        run: |
          { echo "### Packages changed";
            echo '```';
            nix store diff-closures ./before ./after || true;
            echo '```';
          } > /tmp/body.md

      - name: ğŸš€ Create pull request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/update-flake
          title: "chore: update flake.lock"
          body-path: /tmp/body.md
          delete-branch: true
          #labels: dependencies,nix
          add-paths: |
            flake.lock

      - name: ğŸ¤– Enable autoâ€‘merge
        if: ${{ steps.create-pr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
