name: Test Nix Availability

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-nix:
    runs-on: ubuntu-latest
    name: Test Nix Tool Availability and Flakes Support
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Verify Nix installation
        run: |
          echo "Testing basic Nix availability..."
          nix --version
          echo "‚úÖ Nix command is available"

      - name: Test Nix flakes functionality
        run: |
          echo "Testing Nix flakes support with cowsay..."
          nix run nixpkgs#cowsay -- "Nix flakes are working! üêÑ"
          echo "‚úÖ Nix flakes functionality verified"

      - name: Test project flake evaluation
        run: |
          echo "Testing project flake evaluation..."
          nix flake show
          echo "‚úÖ Project flake can be evaluated"

      - name: Test Docker image build capability
        run: |
          echo "Testing Docker image build (quick validation)..."
          nix build .#docker --print-build-logs
          echo "‚úÖ Docker image builds successfully"
          
          # Verify the image was created
          ls -la result
          file result