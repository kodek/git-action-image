name: Test Nix Availability in Docker Image

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-nix-in-image:
    runs-on: ubuntu-latest
    name: Build Docker Image and Test Nix Availability
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build Docker image
        run: |
          echo "Building Docker image with Nix..."
          nix build .#docker --print-build-logs
          echo "‚úÖ Docker image built successfully"

      - name: Load Docker image
        run: |
          echo "Loading Docker image..."
          docker load < result
          echo "‚úÖ Docker image loaded"
          
          # List available images to confirm
          docker images | grep git-actions-base

      - name: Test Nix availability in container
        run: |
          echo "Testing if Nix is available inside the container..."
          if docker run --rm git-actions-base:latest nix --version; then
            echo "‚úÖ Nix command is available in the container"
          else
            echo "‚ùå Nix command is NOT available in the container"
            echo "Available commands in container:"
            docker run --rm git-actions-base:latest ls /nix/store/ 2>/dev/null | head -10 || echo "No /nix/store found"
            exit 1
          fi

      - name: Test Nix flakes functionality in container
        run: |
          echo "Testing Nix flakes support inside the container..."
          if docker run --rm git-actions-base:latest nix run nixpkgs#cowsay -- "Nix flakes are working in container! üêÑ"; then
            echo "‚úÖ Nix flakes functionality verified in container"
          else
            echo "‚ùå Nix flakes functionality failed in container"
            exit 1
          fi